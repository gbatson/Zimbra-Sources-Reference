<project name="Offline-Installer" default="default">

	<property file="build.properties"/>
	<property name="media_win32" value="zdesktop_${offline.filever}_${offline.branch}_b${offline.buildid}_${offline.suffix_win32}"/>
	<property name="media_macos" value="zdesktop_${offline.filever}_${offline.branch}_b${offline.buildid}_${offline.suffix_macos}"/>
	<property name="media_linux" value="zdesktop_${offline.filever}_${offline.branch}_b${offline.buildid}_${offline.suffix_linux}"/>
	<property name="media_linux_dir" value="zdesktop_${offline.filever}_${offline.branch}_b${offline.buildid}_linux_i686"/>
	<property name="build.dir" location="../ZimbraBuild/i386" />
	<property name="pmdoc.dir" location="./build/macos_installer.pmdoc" />
	<property name="wxs.dir" location="${basedir}\build" />
	<property name="prism.app" value="build/dist/app/macos/prism/Prism.app" />
	<property name="updater.app" value="build/dist/app/macos/prism/Prism.app/Contents/Frameworks/XUL.framework/updater.app" />
	<property name="zd.app" value="${basedir}/build/dist/app/macos/Zimbra Desktop.app" />
	<property name="winperl" value="C:\strawberry\perl\bin\perl.exe" />
	<property name="wix.home" value="C:\Program Files\Windows Installer XML v3" />
 
  	<condition property="is-mac">
		<os family="mac"/>
	</condition>
	<condition property="is-windows">
		<os family="windows"/>
	</condition>
	<condition property="is-linux">
        <and>
            <os family="unix"/>
            <not>
                <os family="mac"/>
            </not>
        </and>
	</condition>
  
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="../ZimbraCommon/jars/ant-contrib-1.0b1.jar" />
		</classpath>
	</taskdef>

	<target name="installer-clean">
		<delete> <fileset dir="${build.dir}" includes="zdesktop*"/> </delete>
	</target>

	<target name="default">
        <ant dir="." target="offline-make-install-files" inheritAll="false"/>
       	<mkdir dir="${build.dir}" />

	<if><available file="build/dist/ext/exchange.zip" type="file" /><then> 
		<move tofile="${build.dir}/exchange_${offline.filever}_${offline.branch}_b${offline.buildid}.zip" file="build/dist/ext/exchange.zip"/>
		<delete dir="build/dist/ext"/>
	</then></if>    

	<antcall target="installer-pack-media-mac"/>
        <antcall target="installer-pack-media-windows"/>
        <antcall target="installer-pack-media-linux"/>
        
        <antcall target="gen-update-php"/>
        <antcall target="symlink-media"/>
	</target>
	
	<target name="installer-pack-media-mac" if="is-mac">
		<mkdir dir="${pmdoc.dir}" />
		<copy todir="${pmdoc.dir}" overwrite="true">
			<fileset dir="src/installer/macos/macos_installer.pmdoc" />
		</copy>
		<replace file="${pmdoc.dir}/index.xml" token="@build.root@" value="${basedir}" />
		<replace file="${pmdoc.dir}/01app.xml" token="@build.root@" value="${basedir}" />
		<copy todir="build/dist/app/data/bin" file="src/installer/macos/start-zdesktop" overwrite="true" />
		<copy todir="build/dist/app/data/bin" file="src/installer/macos/stop-zdesktop" overwrite="true" />
		<chmod dir="build/dist/app/data/bin" includes="*" perm="ugo+rx" />
	
		<delete dir="build/dist/app/win32" />
		<delete dir="build/dist/app/linux" />
		<if><available file="${updater.app}" type="dir" /><then>
			<move file="${updater.app}" tofile="${updater.app}_noreloc" preservelastmodified="true" />
		</then></if>
		<if><available file="${prism.app}" type="dir" /><then>
			<move file="${prism.app}" tofile="${prism.app}_noreloc" preservelastmodified="true" />
		</then></if>
		<if><available file="${zd.app}" type="dir" /><then>
			<move file="${zd.app}" tofile="${zd.app}_noreloc" preservelastmodified="true" />
		</then></if>        
		
		<exec executable="src/installer/macos/pmdoc-get-contents.pl" failonerror="true">
			<arg value="${basedir}/build/dist/app" />
			<arg value="${pmdoc.dir}/01app-contents.xml" />
			<arg value="root" />
			<arg value="admin" />
		</exec>

		<exec executable="/Developer/Applications/Utilities/PackageMaker.app/Contents/MacOS/PackageMaker" failonerror="true">
			<arg value="--doc" />
			<arg value="build/macos_installer.pmdoc" />
			<arg value="--title" />
			<arg value="${media_macos}" />
			<arg value="--verbose" />
			<arg value="--no-recommend" />
		</exec>

		<move file="${media_macos}.mpkg" tofile="${build.dir}/${media_macos}.mpkg" preservelastmodified="true" />
		<exec executable="/usr/bin/hdiutil" failonerror="true">
			<arg value="create" />
			<arg value="-srcfolder" />
			<arg value="${build.dir}/${media_macos}.mpkg" />
			<arg value="-volname" />
			<arg value="Zimbra_Desktop_Installer" />
			<arg value="-ov" />
			<arg value="${build.dir}/${media_macos}.dmg" />
			<arg value="-format" />
			<arg value="UDZO" />
			<arg value="-imagekey" />
			<arg value="zlib-level=6" />
		</exec>
		<delete dir="${build.dir}/${media_macos}.mpkg" />
	</target>

	<!-- These open source programs are required for building Windows installer  -->
	<!--   1) WiX v3.0 (http://wix.sourceforge.net/downloadv3.html) "            -->
	<!--   2) Strawberry Perl (http://strawberryperl.com/) "                     -->
	<target name="installer-pack-media-windows" if="is-windows">
		<delete dir="build/dist/app/macos" />
		<delete dir="build/dist/app/linux" />
		<copy todir="build/dist/app/data/bin" file="src/installer/win32/zdctl.vbs" overwrite="true" />
		<copy todir="build/dist/app/data/bin" file="src/installer/win32/zdctl-wrapper.vbs" overwrite="true" />
		<delete file="build/dist/app/data/bin/zdesktop" />
		<delete file="build/dist/app/data/zdesktop.webapp/override.ini.linux" />

		<copy todir="${wxs.dir}" file="src/installer/win32/win_installer.wxs" overwrite="true" />
		<replace file="${wxs.dir}/win_installer.wxs" token="@build.root@" value="${basedir}" />
		<exec executable="${winperl}" failonerror="true">
			<arg value="${basedir}\src\installer\win32\wxs-get-contents.pl" />
			<arg value="${basedir}" />
		</exec>
        
		<exec executable="${wix.home}\bin\candle.exe" failonerror="true">
			<arg value="-out" />
			<arg value="${wxs.dir}\win_installer.wixobj" />
			<arg value="-arch" />
			<arg value="x86" />
			<arg value="-ext" />
			<arg value="${wix.home}\bin\WixUIExtension.dll" />
			<arg value="${wxs.dir}\win_installer.wxs" />			
		</exec>

		<exec executable="${wix.home}\bin\light.exe" failonerror="true">
			<arg value="-sval" />
			<arg value="-cultures:null" />
			<arg value="-ext" />
			<arg value="${wix.home}\bin\WixUIExtension.dll" />
			<arg value="-out" />
			<arg value="${build.dir}\${media_win32}" />
			<arg value="${wxs.dir}\win_installer.wixobj" />       
		</exec>
	</target>
	
	<target name="installer-pack-media-linux" if="is-linux">
		<delete dir="build/dist/app/win32" />
		<delete dir="build/dist/app/macos" />
		<delete file="build/dist/app/data/zdesktop.webapp/override.ini" />
		<move file="build/dist/app/data/zdesktop.webapp/override.ini.linux" tofile="build/dist/app/data/zdesktop.webapp/override.ini" />
		<replace file="build/dist/app/data/zdesktop.webapp/webapp.ini" token="status=false" value="status=true" />
		<copy todir="build/dist" file="src/installer/linux/install.pl" preservelastmodified="true" overwrite="true" />
		<chmod file="build/dist/install.pl" perm="ugo+rx" />

		<mkdir dir="build/dist/${media_linux_dir}" />
		<move todir="build/dist/${media_linux_dir}">
			<fileset dir="build/dist" excludes="${media_linux_dir}" />
		</move>
		<!-- ant's tar task can't preserve permissions. we call gnu tar directly -->
		<exec executable="/bin/tar" failonerror="true">
			<arg value="pcvzf" />
			<arg value="${build.dir}/${media_linux}" />
			<arg value="-C" />
			<arg value="build/dist" />
			<arg value="${media_linux_dir}" />
		</exec>
	</target>
	
	<target name="gen-update-php">
		<copy file="src/installer/update.php" todir="${build.dir}" overwrite="true"/>
		<replace file="${build.dir}/update.php" token="@version@" value="${offline.version}"/>
		<replace file="${build.dir}/update.php" token="@buildid@" value="${offline.buildid}"/>
		<replace file="${build.dir}/update.php" token="@suffix_win32@" value="${offline.suffix_win32}"/>
		<replace file="${build.dir}/update.php" token="@suffix_macos@" value="${offline.suffix_macos}"/>
		<replace file="${build.dir}/update.php" token="@suffix_linux@" value="${offline.suffix_linux}"/>
	
		<if><available file="${build.dir}/${media_win32}" type="file"/><then>
			<checksum file="${build.dir}/${media_win32}" property="hash_win32"/>
			<length file="${build.dir}/${media_win32}" property="size_win32"/>
			<replace file="${build.dir}/update.php" token="@hash_win32@" value="${hash_win32}"/>
			<replace file="${build.dir}/update.php" token="@size_win32@" value="${size_win32}"/>
		</then></if>
	
		<if><available file="${build.dir}/${media_macos}.dmg" type="file"/><then>
			<checksum file="${build.dir}/${media_macos}.dmg" property="hash_macos"/>
			<length file="${build.dir}/${media_macos}.dmg" property="size_macos"/>
			<replace file="${build.dir}/update.php" token="@hash_macos@" value="${hash_macos}"/>
			<replace file="${build.dir}/update.php" token="@size_macos@" value="${size_macos}"/>
		</then></if>
	
		<if><available file="${build.dir}/${media_linux}" type="file"/><then>
			<checksum file="${build.dir}/${media_linux}" property="hash_linux"/>
			<length file="${build.dir}/${media_linux}" property="size_linux"/>
			<replace file="${build.dir}/update.php" token="@hash_linux@" value="${hash_linux}"/>
			<replace file="${build.dir}/update.php" token="@size_linux@" value="${size_linux}"/>
		</then></if>
	</target>

	<target name="symlink-media">
		<if><available file="${build.dir}/${media_linux}" type="file"/><then>
			<delete file="${build.dir}/zdesktop_linux_i686.tgz" quiet="true" />
			<symlink link="${build.dir}/zdesktop_linux_i686.tgz" resource="${media_linux}" overwrite="true"/>
		</then></if>
		<if><available file="${build.dir}/${media_macos}.dmg" type="file"/><then>
			<delete file="${build.dir}/zdesktop_macos_intel.dmg" quiet="true" />
			<symlink link="${build.dir}/zdesktop_macos_intel.dmg" resource="${media_macos}.dmg" overwrite="true"/>
		</then></if>
		<if><available file="${build.dir}/${media_win32}" type="file"/><then>
			<copy tofile="${build.dir}/zdesktop_win32.msi" file="${build.dir}/${media_win32}" overwrite="true"/>
		</then></if>
	</target>
</project>

